# Oxide Lab Mobile – Copilot Instructions
- **Stack & Boundaries:** Jetpack Compose UI under `app/src/main/java/com/oxidelabmobile` drives a Rust/Candle backend in `app/src/main/rust`; Kotlin surfaces everything through `RustInterface.kt`, which loads `liboxide_lab_mobile.so` from `app/src/main/jniLibs/arm64-v8a`.
- **App Entry:** `MainActivity.requestFirstRunPermissionsIfNeeded()` gates storage access (tracks `first_run_permissions_requested` in `app_prefs`), then renders `OxideLabNavHost`.
- **Navigation Flow:** `navigation/Navigation.kt` starts on `EmptyStateScreen`, routes to `ModelSetupScreenNew` for downloads, then `ActiveLabScreen`; drawer actions call `ModelSetupScreenNew` (`manual=true`), `ThinkingModeScreen`, and `AboutScreen`.
- **Model Downloads:** `ModelSetupScreenNew.kt` manages Qwen + Gemma cards; it calls `ModelDownloader.downloadModel()` with a `ProgressListener`, saves to `Environment.getExternalStorageDirectory()/models`, and expects `RustInterface.initializeModelFromFile()` to return a success string immediately.
- **Storage & Cache:** `ModelDownloader` verifies files >1 MB, persists metadata via `ModelCache` (SharedPreferences + disk), and `syncCacheWithFiles()` reconciles stray files; `getDownloadedModels()` infers labels/icons for `ActiveLabScreen`.
- **Rust JNI Contract:** All JNI helpers in `app/src/main/rust/src/jni_bridge.rs` return plain strings and prefix failures with `"Error:"`; Kotlin relies on that sentinel, so keep the pattern when wiring new functions.
- **Candle Backend:** `chatbot/mod.rs` currently does CPU tensor demos; Candle crates are pinned to git tag `0.9.1`. Bolt real inference into `ChatBot::process_message()` and expose new JNI shims rather than bypassing `RustInterface`.
- **Rust Project Layout:** `src/lib.rs` owns Android event handling + logging, while JNI-safe wrappers live in `jni_bridge.rs`; keep logging via `android_logger` with the `oxide_lab_mobile` tag for crash forensics (see `docs/CRASH_FIX_DOCUMENTATION.md`).
- **Permissions & UX:** External storage writes land in `/models`; Android 11+ needs `MANAGE_EXTERNAL_STORAGE`, Android 13+ needs `READ_MEDIA_*`. `MainActivity` already opens Settings when required—reuse that flow when expanding storage usage.
- **Compose Patterns:** `ActiveLabScreen.kt` consumes `DownloadedModel` data, offsets scaffold content with drawer progress, and uses Russian copy throughout; `ComposerField` uses `Spacing`/`Dimensions` tokens from `ui/theme/Tokens.kt`—match those tokens in new UI.
- **Bottom Sheets:** `ModelSettingsSheet` and `MessageContextMenu` in `ui/components/Gestures.kt` expect Boolean state toggles and auto-dismiss after callbacks; replicate the pattern for new sheets.
- **Resources:** Model icons live in `res/drawable` (`qwen.xml`, `gemma.xml`, etc.). When adding a model, ship the drawable and update `DownloadedModel.iconResId` heuristics.
- **Gradle Hooks:** `app/build.gradle.kts` registers `buildRust` (`cargo ndk --target aarch64-linux-android -- build`) and `copyRustLib`, wired as dependencies of `merge*JniLibFolders`; call those tasks or `./gradlew assembleDebug` to refresh the .so after changing JNI.
- **Version Catalog:** Dependencies live in `gradle/libs.versions.toml` (Compose BOM 2025.09.01, Kotlin 2.2.20); prefer adding libs via the catalog instead of hardcoding versions.
- **Testing & Lint:** `./gradlew test`, `connectedAndroidTest`, `ktlintCheck`, `detekt`, and `scripts/lint.(sh|bat)` cover Kotlin; Rust tests run via `cargo test` inside `app/src/main/rust`.
- **Debug Workflow:** `FINAL_DEBUG_SETUP.md` + `debug_setup.md` document ndk-gdb; scripts `debug_native.bat` / `manual_debug.bat` assume SDK at `C:\Users\PC\AppData\Local\Android\Sdk` and NDK 27, with breakpoints like `Java_com_oxidelabmobile_RustInterface_downloadQwenModelTo`.
- **Crash History:** SIGABRT root causes and mitigations live in `docs/CRASH_FIX_DOCUMENTATION.md`; maintain explicit error returns, avoid `catch_unwind`, and ensure model paths are validated on both sides of the bridge.
- **Logging Conventions:** Kotlin uses `android.util.Log` (`ModelDownloader`, `RustInterface`), Rust uses `android_logger`; keep tags consistent for logcat triage.
- **Docs & Guides:** Extra Candle, Gradle, Kotlin, and UI guidance sits in `.cursor/rules/*.mdc`; reference those when expanding backend capabilities or adjusting build logic.
- **Internationalization:** UI copy is currently Russian-first; keep tone consistent and reuse existing strings in `ui/screens/**` until a localization strategy is formalized.
- **Previews & QA:** `ui/screens/**` provide Compose previews; keep them compiling to catch layout regressions quickly.
